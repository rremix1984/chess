# AI聊天窗口设计文档

## 概述
为中国象棋游戏添加AI聊天窗口功能，允许玩家与AI进行棋局讨论，模拟真实对弈时的交流体验。

## 功能特性

### 1. 聊天界面
- **位置**: 游戏界面右侧
- **布局**: 垂直布局，包含聊天记录区域、输入框和发送按钮
- **尺寸**: 宽度300像素，高度与棋盘面板一致
- **样式**: 现代化UI设计，与游戏整体风格保持一致

### 2. AI对话功能
- **模型集成**: 使用Ollama本地部署的大模型（默认deepseek-r1:7b）
- **对话内容**: 
  - 棋局分析和讨论
  - 走法建议和评价
  - 战术和策略交流
  - 棋局形势判断

### 3. 棋盘状态感知
- **实时更新**: 每次棋子移动后自动更新棋盘状态
- **状态描述**: 自动生成当前棋盘的文字描述
- **上下文维护**: 保持对话的连续性和相关性

## 技术实现

### 1. 核心组件

#### ChatPanel.java
```java
public class ChatPanel extends JPanel {
    // 聊天记录显示区域
    private JTextArea chatArea;
    
    // 用户输入框
    private JTextField inputField;
    
    // 发送按钮
    private JButton sendButton;
    
    // 棋盘引用
    private Board board;
    
    // AI模型名称
    private String modelName;
}
```

#### 主要方法
- `sendMessage()`: 发送用户消息并获取AI回复
- `getAIResponse()`: 与Ollama API交互获取AI回复
- `buildChatPrompt()`: 构建聊天提示词
- `describeBoardState()`: 描述当前棋盘状态
- `updateBoardState()`: 更新棋盘状态

### 2. 界面集成

#### GameFrame.java 修改
- 窗口宽度从800增加到1200像素
- 使用BorderLayout布局：
  - CENTER: 主面板（棋盘+聊天）
  - NORTH: 控制面板
  - SOUTH: 状态栏
- 主面板内部布局：
  - CENTER: 棋盘面板
  - EAST: 聊天面板

#### BoardPanel.java 修改
- 添加聊天面板引用
- 在棋子移动后通知聊天面板更新状态
- 支持人类移动和AI移动的状态通知

### 3. AI交互机制

#### HTTP请求格式
```json
{
    "model": "deepseek-r1:7b",
    "prompt": "系统提示词 + 棋盘状态 + 用户消息",
    "stream": false
}
```

#### 提示词模板
- **角色定义**: 专业象棋AI助手
- **能力描述**: 棋局分析、走法建议、战术讨论
- **交流风格**: 友好、专业、有见地
- **棋盘状态**: 实时FEN格式或文字描述

### 4. 错误处理
- **网络异常**: 显示连接错误提示
- **模型异常**: 提供备用回复
- **输入验证**: 防止空消息发送
- **超时处理**: 设置合理的请求超时时间

## 用户体验设计

### 1. 交互流程
1. 用户在输入框输入消息
2. 点击发送按钮或按Enter键
3. 消息显示在聊天记录中
4. AI分析当前棋局并生成回复
5. AI回复显示在聊天记录中
6. 支持连续对话

### 2. 视觉设计
- **聊天气泡**: 用户消息右对齐，AI消息左对齐
- **颜色区分**: 用户消息蓝色背景，AI消息灰色背景
- **字体**: 清晰易读的中文字体
- **滚动**: 自动滚动到最新消息

### 3. 功能联动
- **AI开关**: 与游戏AI功能联动，启用AI时自动启用聊天
- **模型选择**: 聊天使用与游戏AI相同的模型
- **新游戏**: 重新开始游戏时清空聊天记录

## 扩展功能

### 1. 聊天记录
- 保存对话历史
- 支持导出聊天记录
- 搜索历史消息

### 2. 多语言支持
- 支持中英文切换
- 国际象棋术语翻译

### 3. 个性化设置
- 自定义AI回复风格
- 调整聊天窗口大小
- 主题颜色设置

## 性能优化

### 1. 响应速度
- 异步处理AI请求
- 本地缓存常用回复
- 优化提示词长度

### 2. 资源管理
- 合理的HTTP连接池
- 内存使用优化
- 线程安全保证

## 测试策略

### 1. 功能测试
- 消息发送和接收
- 棋盘状态同步
- AI回复质量
- 错误处理机制

### 2. 性能测试
- 响应时间测试
- 并发请求测试
- 内存泄漏检测

### 3. 用户体验测试
- 界面友好性
- 操作便捷性
- 对话连贯性

## 部署要求

### 1. 环境依赖
- Java 11+
- Ollama服务运行在localhost:11434
- 已下载deepseek-r1:7b模型

### 2. 配置参数
- 模型名称可配置
- API端点可配置
- 超时时间可调整

## 总结
AI聊天窗口为象棋游戏增加了智能交互维度，提升了用户体验。通过与大模型的集成，实现了自然的棋局讨论功能，让单人对弈更加有趣和富有教育意义。